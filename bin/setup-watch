#!/bin/bash
SETUP_INSTALL_DIR="$HOME/Projects/packages/src/setup"
root="$(dirname "$1")"
file="${1#$root/}"
cd "$root"
source "$SETUP_INSTALL_DIR"/lib/setup.shl

declare -A tracked_files=( )
mkfifo "$SETUP_TMPDIR/inotify-out"
function track-files() {
    local arg
    for arg; do
	if [ "${tracked_files[$arg]:+x}" == '' ]; then
	    echo "Watching $arg"
	    inotifywait -q -m "$arg" > "$SETUP_TMPDIR/inotify-out" &
	    tracked_files[$arg]="$!"
	fi
    done
}

Setup.use base
source "$file"
setup
track-files "${SETUP_SOURCE_FILES[@]}"

while read root ev file; do
    case ",$ev," in
	*,CLOSE_WRITE,*)
	    echo "Written $root"
	    reset-sources "$root"
	    track-files "${SETUP_SOURCE_FILES[@]}"
	    ;;
    esac
done < "$SETUP_TMPDIR/inotify-out"
kill "${tracked_files[@]}"
